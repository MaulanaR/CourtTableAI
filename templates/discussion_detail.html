<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discussion Detail - Court Table AI</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="/static/css/stripe.css">
    <style>
        .agent-response {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0%, 20%, 50%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
            60% { opacity: 1; }
        }
        #transcript-container::-webkit-scrollbar {
            width: 6px;
        }
        #transcript-container::-webkit-scrollbar-track {
            background: #f6f9fc;
        }
        #transcript-container::-webkit-scrollbar-thumb {
            background: #e6ebf1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-[#f6f9fc]">
    <nav class="stripe-nav sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center">
                        <img src="/static/logo/logo.png" alt="Logo" class="h-10 w-auto mr-3">
                        <span class="text-[#6772e5] font-bold text-2xl tracking-tight">CourtTableAI</span>
                    </a>
                </div>
                <div class="flex items-center">
                    <a href="/" class="stripe-nav-link">Dashboard</a>
                    <a href="/agents" class="stripe-nav-link">Agents</a>
                    <a href="/discussions" class="stripe-nav-link">Discussions</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumbs -->
        <nav class="flex mb-6 text-sm" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/discussions" class="text-[#6b7c93] hover:text-[#6772e5]">Discussions</a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-3 h-3 text-[#8898aa] mx-1" aria-hidden="true" fill="none" viewBox="0 0 6 10"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/></svg>
                        <span class="text-[#32325d] font-semibold ml-1">#{{ .Discussion.ID }}</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Discussion Header -->
        <div class="stripe-card p-8 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="stripe-badge {{ if eq .Discussion.Status "running" }}stripe-badge-warning animate-pulse{{ else if eq .Discussion.Status "completed" }}stripe-badge-success{{ else }}stripe-badge-danger{{ end }}">
                            {{ .Discussion.Status }}
                        </span>
                        <h1 class="text-2xl font-bold text-[#32325d]">{{ .Discussion.Topic }}</h1>
                    </div>
                    <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-[#6b7c93]">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            {{ .Discussion.CreatedAt.Format "Jan 02, 2006 15:04" }}
                        </div>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg>
                            {{ .Discussion.Language }}
                        </div>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            {{ .Discussion.MaxRounds }} Rounds
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3 self-end md:self-auto">
                    {{ if eq .Discussion.Status "running" }}
                    <button onclick="stopDiscussion({{ .Discussion.ID }})" class="bg-white border border-[#e6ebf1] text-[#e13d3d] font-bold px-4 py-2 rounded shadow-sm hover:bg-[#fcebeb] transition-colors">
                        Stop Debate
                    </button>
                    {{ end }}
                    <button onclick="location.reload()" class="p-2 text-[#6b7c93] hover:text-[#6772e5] bg-white border border-[#e6ebf1] rounded shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Transcript Column -->
            <div class="lg:col-span-3 space-y-6">
                <div class="stripe-card overflow-hidden">
                    <div class="px-6 py-4 border-b border-[#e6ebf1] bg-[#f6f9fc] flex justify-between items-center">
                        <h2 class="text-sm font-bold text-[#8898aa] uppercase tracking-wider">Live Transcript</h2>
                        <span id="response-count" class="text-xs font-bold text-[#6772e5] bg-[#e6ebf1] px-2 py-0.5 rounded-full">{{ len .Logs }} Messages</span>
                    </div>
                    <div id="transcript-container" class="divide-y divide-[#e6ebf1] bg-white overflow-y-auto" style="max-height: 700px;">
                        {{ if .Logs }}
                        {{ range .Logs }}
                        <div class="p-8 agent-response hover:bg-[#fafcfe] transition-colors {{ if .IsModerator }}bg-[#f8f9ff]{{ end }}" data-log-id="{{ .ID }}">
                            <div class="flex items-start gap-5">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 {{ if .IsModerator }}bg-[#6772e5]{{ else }}bg-[#32325d]{{ end }} rounded-full flex items-center justify-center text-white font-bold shadow-sm">
                                        {{ if .IsModerator }}M{{ else }}
                                            {{ $logAgentID := .AgentID }}
                                            {{ $initial := "A" }}
                                            {{ range $.Agents }}
                                                {{ if eq .ID $logAgentID }}{{ $initial = substr .Name 0 1 | upper }}{{ end }}
                                            {{ end }}
                                            {{ $initial }}
                                        {{ end }}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-[#32325d]">
                                                {{ if .IsModerator }}
                                                    Moderator 
                                                    {{ $modName := "" }}{{ $logAgentID := .AgentID }}{{ range $.Agents }}{{ if eq .ID $logAgentID }}{{ $modName = .Name }}{{ end }}{{ end }}
                                                    <span class="text-xs font-medium text-[#6b7c93] ml-1">({{ $modName }})</span>
                                                {{ else }}
                                                    {{ $agentName := "" }}{{ $logAgentID := .AgentID }}{{ range $.Agents }}{{ if eq .ID $logAgentID }}{{ $agentName = .Name }}{{ end }}{{ end }}
                                                    {{ $agentName }}
                                                {{ end }}
                                            </span>
                                            <span class="text-xs text-[#8898aa]">{{ .CreatedAt.Format "15:04:05" }}</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded border {{ if eq .Status "success" }}text-[#24b47e] border-[#24b47e] bg-[#e3f9eb]{{ else }}text-[#e13d3d] border-[#e13d3d] bg-[#fcebeb]{{ end }}">
                                                {{ upper .Status }}
                                            </span>
                                            <span class="text-xs text-[#8898aa]">{{ .ResponseTime }}ms</span>
                                            {{ if and (ne .Status "success") (not .IsModerator) }}
                                            <button onclick="retryAgent({{ $.Discussion.ID }}, {{ .AgentID }})" class="text-xs font-bold text-[#6772e5] hover:underline">Retry</button>
                                            {{ end }}
                                        </div>
                                    </div>
                                    <div class="text-[#4f566b] text-[15px] leading-relaxed markdown-content">{{ .Content }}</div>
                                </div>
                            </div>
                        </div>
                        {{ end }}
                        {{ else }}
                        <div id="no-logs" class="p-20 text-center">
                            <div class="flex flex-col items-center">
                                <div class="typing-indicator text-[#6772e5] font-bold mb-2">Waiting for responses</div>
                                <p class="text-[#8898aa] text-sm">Debate is starting up...</p>
                            </div>
                        </div>
                        {{ end }}
                    </div>
                </div>

                <!-- Final Summary (Full Width at Bottom of main col) -->
                {{ if .Discussion.FinalSummary }}
                <div class="stripe-card overflow-hidden">
                    <div class="px-6 py-4 border-b border-[#e6ebf1] bg-[#f6f9fc]">
                        <h2 class="text-sm font-bold text-[#8898aa] uppercase tracking-wider">Final Debate Summary</h2>
                    </div>
                    <div class="p-8 text-[#4f566b] text-[15px] leading-relaxed whitespace-pre-wrap">{{ .Discussion.FinalSummary }}</div>
                </div>
                {{ end }}
            </div>

            <!-- Sidebar Column -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Participants List -->
                <div class="stripe-card p-6">
                    <h3 class="text-sm font-bold text-[#8898aa] uppercase tracking-wider mb-5">Participants</h3>
                    
                    {{ if .Discussion.ModeratorID }}
                    <div class="mb-6">
                        <p class="text-[11px] font-bold text-[#8898aa] uppercase mb-3">Moderator</p>
                        {{ $modID := .Discussion.ModeratorID }}
                        {{ range .Agents }}{{ if isModerator .ID $modID }}
                        <div class="flex items-center gap-3 p-2 rounded-lg bg-[#f8f9ff]">
                            <div class="w-8 h-8 bg-[#6772e5] rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm">M</div>
                            <div class="min-w-0">
                                <p class="text-sm font-bold text-[#32325d] truncate">{{ .Name }}</p>
                                <p class="text-xs text-[#8898aa] truncate">{{ .ModelName }}</p>
                            </div>
                        </div>
                        {{ end }}{{ end }}
                    </div>
                    {{ end }}
                    
                    <div>
                        <p class="text-[11px] font-bold text-[#8898aa] uppercase mb-3">Debaters</p>
                        <div class="space-y-3">
                            {{ range .Discussion.AgentIDs }}
                            {{ $currentAgentID := . }}{{ range $.Agents }}{{ if eq .ID $currentAgentID }}
                            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-[#f6f9fc] transition-colors group">
                                <div class="w-8 h-8 bg-[#32325d] group-hover:bg-[#6772e5] transition-colors rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm">
                                    {{ substr .Name 0 1 | upper }}
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-bold text-[#32325d] truncate">{{ .Name }}</p>
                                    <p class="text-xs text-[#8898aa] truncate">{{ .ModelName }}</p>
                                </div>
                            </div>
                            {{ end }}{{ end }}{{ end }}
                        </div>
                    </div>
                </div>

                <!-- Session Settings Info -->
                <div class="stripe-card p-6">
                    <h3 class="text-sm font-bold text-[#8898aa] uppercase tracking-wider mb-4">Configuration</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-[#6b7c93]">Language</span>
                            <span class="font-bold text-[#32325d]">{{ .Discussion.Language }}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-[#6b7c93]">Max Rounds</span>
                            <span class="font-bold text-[#32325d]">{{ .Discussion.MaxRounds }}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-[#6b7c93]">Char Limit</span>
                            <span class="font-bold text-[#32325d]">{{ .Discussion.MaxCharLimit }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const discussionId = {{ .Discussion.ID }};
        const currentStatus = "{{ .Discussion.Status }}";

        // Initialize marked with highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            headerIds: false,
            mangle: false
        });

        function renderMarkdown(element) {
            const rawContent = element.textContent;
            element.innerHTML = marked.parse(rawContent);
            
            // Add copy buttons to code blocks
            element.querySelectorAll('pre').forEach(pre => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                button.onclick = () => {
                    const code = pre.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        setTimeout(() => button.textContent = 'Copy', 2000);
                    });
                };
                pre.appendChild(button);
            });
        }

        function stopDiscussion(id) {
            if (confirm('Are you sure you want to stop this discussion?')) {
                fetch(`/api/discussions/${id}/stop`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'stopped') {
                        location.reload();
                    } else {
                        alert('Failed to stop discussion: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error stopping discussion:', error);
                    alert('Failed to stop discussion: ' + error.message);
                });
            }
        }

        function retryAgent(discussionId, agentId) {
            if (confirm('Retry this agent\'s response?')) {
                fetch(`/api/discussions/${discussionId}/retry/${agentId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'retry initiated') {
                        // SSE will handle the update
                    } else {
                        alert('Failed to retry agent: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error retrying agent:', error);
                    alert('Failed to retry agent: ' + error.message);
                });
            }
        }

        // Setup SSE for real-time updates
        function setupSSE() {
            if (currentStatus !== 'running') return;

            const eventSource = new EventSource(`/api/discussions/${discussionId}/stream`);

            eventSource.addEventListener('log', function(e) {
                const data = JSON.parse(e.data);
                appendLog(data.log, data.agent);
            });

            eventSource.addEventListener('discussion', function(e) {
                const discussion = JSON.parse(e.data);
                updateDiscussionStatus(discussion);
                if (discussion.status !== 'running') {
                    eventSource.close();
                    setTimeout(() => location.reload(), 3000);
                }
            });

            eventSource.onerror = function(err) {
                console.error('SSE Error:', err);
                eventSource.close();
                // Fallback to polling if SSE fails
                if (currentStatus === 'running') {
                    setTimeout(setupSSE, 5000);
                }
            };
        }

        function appendLog(log, agent) {
            // Check if log already exists
            if (document.querySelector(`[data-log-id="${log.id}"]`)) return;

            const container = document.getElementById('transcript-container');
            const placeholder = container.querySelector('.typing-indicator')?.parentElement;
            if (placeholder) placeholder.remove();

            const logDiv = document.createElement('div');
            logDiv.className = `p-8 agent-response hover:bg-[#fafcfe] transition-colors ${log.is_moderator ? 'bg-[#f8f9ff]' : ''}`;
            logDiv.setAttribute('data-log-id', log.id);

            const createdAt = new Date(log.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });

            // Calculate initial for SSE agent if not provided
            const initial = agent.initial || agent.name.charAt(0).toUpperCase();

            logDiv.innerHTML = `
                <div class="flex items-start gap-5">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 ${log.is_moderator ? 'bg-[#6772e5]' : 'bg-[#32325d]'} rounded-full flex items-center justify-center text-white font-bold shadow-sm">
                            ${log.is_moderator ? 'M' : initial}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[#32325d]">
                                    ${log.is_moderator ? 'Moderator <span class="text-xs font-medium text-[#6b7c93] ml-1">(' + agent.name + ')</span>' : agent.name}
                                </span>
                                <span class="text-xs text-[#8898aa]">${createdAt}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded border ${log.status === 'success' ? 'text-[#24b47e] border-[#24b47e] bg-[#e3f9eb]' : 'text-[#e13d3d] border-[#e13d3d] bg-[#fcebeb]'}">
                                    ${log.status.toUpperCase()}
                                </span>
                                <span class="text-xs text-[#8898aa]">${log.response_time}ms</span>
                            </div>
                        </div>
                        <div class="text-[#4f566b] text-[15px] leading-relaxed markdown-content">${log.content}</div>
                    </div>
                </div>
            `;

            container.appendChild(logDiv);
            renderMarkdown(logDiv.querySelector('.markdown-content'));
            scrollToBottom();
        }

        function updateDiscussionStatus(discussion) {
            const statusBadge = document.querySelector('.bg-yellow-100, .bg-green-100, .bg-red-100');
            if (statusBadge) {
                statusBadge.textContent = discussion.status;
                if (discussion.status !== 'running') {
                    statusBadge.className = 'px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800';
                    const stopBtn = document.querySelector('button[onclick^="stopDiscussion"]');
                    if (stopBtn) stopBtn.remove();
                }
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('transcript-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        window.addEventListener('load', () => {
            // Initial Markdown rendering for existing logs
            document.querySelectorAll('.markdown-content').forEach(renderMarkdown);
            scrollToBottom();
            setupSSE();
        });
    </script>
</body>
</html>
